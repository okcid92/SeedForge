{% extends "base.html" %}

{% block header %}Recherche de Torrents{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <!-- Search Bar -->
    <div class="bg-slate-900/50 rounded-xl border border-primary/10 p-6">
        <div class="flex gap-3">
            <div class="relative flex-1">
                <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                <input type="text" id="searchQuery" placeholder="Rechercher des torrents..." class="w-full pl-12 pr-4 py-3 bg-slate-800 border-slate-700 rounded-lg text-white text-lg focus:border-primary focus:ring-1 focus:ring-primary">
            </div>
            <button onclick="searchTorrents()" class="px-8 py-3 bg-primary rounded-lg text-white font-bold hover:bg-primary/90 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined">search</span>
                Rechercher
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="text-sm text-slate-400"></div>

    <!-- Loading -->
    <div id="loading" style="display:none;" class="flex items-center justify-center py-12">
        <div class="flex items-center gap-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="text-slate-400">Recherche en cours...</p>
        </div>
    </div>

    <!-- Results -->
    <div id="results"></div>
</div>

<script>
let allResults = [];
let currentPage = 1;
const perPage = 20;

function searchTorrents() {
    const query = document.getElementById('searchQuery').value;
    if (!query) return;
    
    allResults = [];
    currentPage = 1;
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('results').innerHTML = '';
    document.getElementById('stats').innerHTML = '';
    
    searchLocal(query);
    
    fetch('/api/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({query: query})
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        allResults = data.results;
        displayPage(1);
    });
}

function searchLocal(query) {
    const localDB = [
        {name: 'Ubuntu 24.04 LTS Desktop', seeders: 1500, leechers: 200, size: '5.7 GB', hash: 'a'.repeat(40), source: 'Local'},
        {name: 'Ubuntu 22.04 LTS Server', seeders: 800, leechers: 100, size: '2.5 GB', hash: 'b'.repeat(40), source: 'Local'},
        {name: 'Debian 12 Bookworm', seeders: 600, leechers: 80, size: '4.2 GB', hash: 'c'.repeat(40), source: 'Local'},
        {name: 'Linux Mint 21.3', seeders: 900, leechers: 150, size: '3.1 GB', hash: 'd'.repeat(40), source: 'Local'},
        {name: 'Big Buck Bunny 1080p', seeders: 2000, leechers: 300, size: '1.5 GB', hash: 'g'.repeat(40), source: 'Local'},
        {name: 'Sintel 4K', seeders: 1200, leechers: 180, size: '3.2 GB', hash: 'h'.repeat(40), source: 'Local'},
        {name: 'Blender Open Movie Collection', seeders: 500, leechers: 70, size: '8.5 GB', hash: 'j'.repeat(40), source: 'Local'}
    ];
    
    const filtered = localDB.filter(item => item.name.toLowerCase().includes(query.toLowerCase()));
    if (filtered.length > 0) {
        allResults = filtered;
        displayPage(1);
        document.getElementById('stats').innerHTML = `‚ö° ${filtered.length} r√©sultats locaux (recherche en ligne en cours...)`;
    }
}

function displayPage(page) {
    currentPage = page;
    const start = (page - 1) * perPage;
    const end = start + perPage;
    const pageResults = allResults.slice(start, end);
    
    if (pageResults.length === 0) {
        document.getElementById('results').innerHTML = `
            <div class="flex flex-col items-center justify-center py-20 text-center">
                <div class="size-20 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 mb-4">
                    <span class="material-symbols-outlined text-4xl">search_off</span>
                </div>
                <h3 class="text-xl font-bold mb-2">Aucun r√©sultat</h3>
                <p class="text-slate-400">Essayez avec d'autres mots-cl√©s</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="space-y-3">';
    
    pageResults.forEach(r => {
        const magnet = r.magnet || `magnet:?xt=urn:btih:${r.hash}&dn=${encodeURIComponent(r.name)}`;
        html += `
            <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4 hover:border-primary/40 transition-all group">
                <div class="flex items-center gap-4">
                    <div class="size-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary shrink-0">
                        <span class="material-symbols-outlined">description</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold truncate mb-1">${r.name}</h3>
                        <div class="flex items-center gap-4 text-xs text-slate-400">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">download</span>
                                ${r.size}
                            </span>
                            <span class="text-green-400 font-bold">‚Üë ${r.seeders}</span>
                            <span class="text-orange-400 font-bold">‚Üì ${r.leechers}</span>
                            <span class="px-2 py-0.5 rounded bg-primary/10 text-primary text-xs font-bold">${r.source}</span>
                        </div>
                    </div>
                    <form method="POST" action="/add-from-search" class="shrink-0">
                        <input type="hidden" name="magnet" value="${magnet}">
                        <input type="hidden" name="name" value="${r.name}">
                        <input type="hidden" name="size" value="${r.size}">
                        <button type="submit" class="px-4 py-2 bg-primary rounded-lg text-white text-sm font-bold hover:bg-primary/90 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">download</span>
                            T√©l√©charger
                        </button>
                    </form>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Pagination
    const totalPages = Math.ceil(allResults.length / perPage);
    if (totalPages > 1) {
        html += '<div class="flex justify-center gap-2 mt-6">';
        for (let i = 1; i <= totalPages; i++) {
            html += `<button onclick="displayPage(${i})" class="px-4 py-2 rounded-lg ${i === page ? 'bg-primary text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'} transition-colors">${i}</button>`;
        }
        html += '</div>';
    }
    
    document.getElementById('results').innerHTML = html;
    document.getElementById('stats').innerHTML = `üìä ${allResults.length} r√©sultats trouv√©s (page ${page}/${totalPages})`;
}

document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchTorrents();
});
</script>
{% endblock %}
